<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.iei.freeboard.model.dao.FreeBoardDao">

	<select id="selectCategoryList" resultType = "freeBoardCategory">
 		SELECT 
			free_board_category_no ,FREE_BOARD_CATEGORY, free_board_subcategory_no, FREE_BOARD_SUBCATEGORY 
			FROM FREE_BOARD_SUB_CATEGORY_TBL 
		JOIN FREE_BOARD_CATEGORY_TBL USING (FREE_BOARD_CATEGORY_NO)
	</select>  
	
	<select id="searchTitle" resultType = "freeBoard">
		select * 
		from (
    		select rownum as fbnum, fb.* 
    			from (
            		select f.*, 
            		m.member_nickname, 
            		m.member_id, 
            		(select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
            from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
            where free_board_title like '%' || #{freeBoardTitle} || '%'
            <if test="order == 2">
            	order by free_board_no desc
            </if>
    		<if test="order == 1">
    			order by free_board_no asc
    		</if>
          	) fb
        )
        where fbnum between #{startRow} and #{endRow}
	</select>
	
	 <select id="totalSearchListCount" resultType="int">
	 	select count(*) from free_board_tbl where free_board_title like '%' || #{freeBoardTitle} || '%'
	 </select>
	 
	<select id="boardList" resultType="freeBoard">
		select * from free_board_tbl
	</select>
	
	<select id="totalBoardList" resultType = "freeBoard">
		select * from
    		(select rownum as fbnum, fb.* from
            	(select f.*, m.member_nickname, m.member_id, (select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
                from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
            <if test="order == 2">
            	order by free_board_no desc
            </if>
    		<if test="order == 1">
    			order by free_board_no asc
    		</if>
            ) fb
            <if test="selected != null">
            	where free_board_subcategory_no = #{selected}
            </if>
          	)
        where fbnum between #{startRow} and #{endRow}
	</select>
	
	<select id="totalListCount" resultType="int">
		select count(*) from free_board_tbl
	</select>
	
	<select id="totalBoardSubList" resultType = "freeBoard">
		select * from
    		(select rownum as fbnum, fb.* from
            	(select f.*, m.member_nickname, m.member_id, (select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
                from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
            ) fb
            <if test="selected != null">
            	where free_board_subcategory_no = #{selected}
            </if>
            <if test="order == 2">
            	order by free_board_no desc
            </if>
    		<if test="order == 1">
    			order by free_board_no asc
    		</if>
          	)
        where fbnum between #{startRow} and #{endRow} 
	</select>
	
	<select id="totalSubListCount" resultType = "int">
		select count(*) from free_board_tbl where free_board_subcategory_no = #{selected}
	</select>
	 
	 <select id="mainTitle" resultType="freeBoard">
	 	<![CDATA[
		    SELECT b.free_board_no,
		           b.free_board_title,
		           b.member_no,
		           b.free_board_date,
		           m.member_nickname
		    FROM (
		        SELECT free_board_no,
		               free_board_title,
		               free_board_date,
		               
		               member_no
		        FROM free_board_tbl
		        ORDER BY free_board_no DESC
		    ) b
		    JOIN member_tbl m
		    ON b.member_no = m.member_no
		    WHERE ROWNUM <= #{limit}
		]]>
	 </select>
	 
	 <select id="isSubCategory" resultType = "freeBoardCategory">
	 	select rownum no, a.* 
    		from (select free_board_category_no, free_board_subcategory_no, free_board_subCategory 
        		from (select * from free_board_category_tbl 
            where free_board_category=#{cate}) 
        join free_board_sub_category_tbl using(free_board_category_no)) a
	 </select>
	 
	 <select id="mainCategory" resultType="freeBoard">	
	 	<![CDATA[ 
		    SELECT  b.free_board_no,
        			b.free_board_title,
        			b.member_no,
        			b.free_board_category_no,
        			b.free_board_date,
					m.member_nickname
			FROM (
					SELECT 
							free_board_no,
		       				free_board_title,
               				free_board_category_no,
		       				free_board_date,
		       				member_no
					FROM free_board_tbl			
					WHERE free_board_category_no = #{freeBoardCategoryNo}
		     		ORDER BY free_board_no DESC
			) b
			JOIN member_tbl m
			ON b.member_no = m.member_no		
			WHERE rownum <= 10
		]]>		
	 </select>
	 
	 <select id="getFreeBoardNo" resultType ="int">
	 	select free_board_seq.nextval from dual
	 </select>
	 
	 <insert id="insertFreeBoard">
	 	insert into free_board_tbl values
	 		(
	 		#{freeBoardNo}, 
	 		#{freeBoardSubcategoryNo}, 
	 		#{freeBoardCategoryNo}, 
	 		#{freeBoardTitle}, 
	 		#{memberNo}, 
	 		#{freeBoardContent}, 
	 		sysdate, 
	 		#{freeBoardThumbnail}
	 		)
	 </insert>
	 <!-- 
	 <insert id="insertFreeBoardFile">
	 	insert into fb_photo_tbl values
	 		(
	 		#{freeBoardCategoryNo}, 
	 		#{freeBoardSubcategoryNo},
	 		#{freeBoardNo}, 
	 		fb_photo_seq.nextval, 
	 		#{FBPhotopath}, 
	 		#{FBPhotoname}
	 		)
	 </insert>
	  -->
	 <select id="selectOneDetail" resultType="freeBoard">
	 	select f.*, m.member_nickname, m.member_id, (select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
                from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
        	 where free_board_no = #{freeBoardNo}
	 </select>
	 <select id="totalCommentList" resultType = "freeBoardComment">
		select *
			from (
		    	select rownum as pnum, t.*
		    		from (
					 	select 
					 		total.*,
					 		(select count(*)
					 			from fb_comment_tbl
					 			where free_board_no = #{freeBoardNo}
					 		) as total_comment_count
							    from (
							        select * 
							            from (
							                select * 
								                from (
								                    select 
								                        a.free_board_no,
								                        b.fb_comment_no,
								                        b.fb_comment_content,
								                        a.free_board_date,
								                        b.fb_comment_date,
								                        b.member_no,
								                        count(fb_comment_no) as comment_count
								                    from free_board_tbl a 
								                    left join fb_comment_tbl b 
								                        on (a.free_board_no = b.free_board_no)
								                    group by 
								                        a.free_board_no, 
								                        b.fb_comment_no, 
								                        b.fb_comment_content,
								                        a.free_board_date, 
								                        b.fb_comment_date, 
								                        b.member_no
							                	) 
							                left join (
							                    select 
							                        member_no,
							                        member_nickname,
							                        member_id 
							                    from member_tbl
							                ) using (member_no)
							            )
							        left join (
							            select 
							                fb_comment_no,
							                count(*) as cnt 
							            from fb_comment_tbl 
							            group by fb_comment_no
							        ) using (fb_comment_no)
							    )
							where free_board_no = #{freeBoardNo}
							<if test="order == 2">
								order by fb_comment_no desc
							</if>
							<if test="order == 1">
								order by fb_comment_no asc
							</if>
						) total
				    ) t
				)
			where pnum between #{startRow} and #{endRow}
	 </select>
	 <select id="totalCommentListCount" resultType = "int">
	 	select count(*) from fb_comment_tbl where free_board_no = #{freeBoardNo}
	 </select>
		
	<insert id="insertComment">
		insert into fb_comment_tbl values 
			(
			fb_comment_seq.nextval,
			#{freeBoardNo},
			#{freeBoardSubcategoryNo},
			#{freeBoardCategoryNo},
			#{memberNo},
			#{fbCommentContent},
			sysdate,
			'F',
			null
			)
	</insert> 
	 
	 <select id="selectOneBoard" resultType = "freeBoard">
	 	select * from free_board_tbl where free_board_no = #{freeBoardNo}
	 </select>
	 <select id="selectCate" resultType="freeBoard">
	 SELECT FREE_BOARD_SUBCATEGORY_NO,FREE_BOARD_CATEGORY_NO FROM FREE_BOARD_TBL WHERE FREE_BOARD_NO=#{freeBoardNo}
	 </select>
	 
	 <insert id="insertClaim">
	 INSERT INTO FB_CLAIM_TBL VALUES(#{freeBoardNo},#{memberNo},#{freeBoardSubcategoryNo},#{freeBoardCategoryNo},SYSDATE,#{fbClaimReason})
	 </insert>
	 
	 <insert id="insertCommentClaim">
	 INSERT INTO FBC_CLAIM_TBL VALUES(#{memberNo},#{fbCommentNo},#{fbcClaimReason},SYSDATE)
	 </insert>
	 
	 <delete id="deleteFreeBoard">
	 	delete from free_board_tbl where free_board_no = #{freeBoardNo}
	 </delete>
	 
	 <select id="selectCategory" resultType = "freeBoardCategory">
	 	select free_board_subcategory, 
	        free_board_category 
	            from free_board_sub_category_tbl 
	        left join free_board_category_tbl using (free_board_category_no)
	    where free_board_subcategory_no = #{freeBoardSubcategoryNo} and free_board_category_no = #{freeBoardCategoryNo}
	 </select>
	 
	 <update id="modifyFreeBoard">
	 	update free_board_tbl set 
	 		free_board_subcategory_no = #{freeBoardSubcategoryNo},
	 		free_board_category_no = #{freeBoardCategoryNo},
	 		free_board_title = #{freeBoardTitle},
	 		free_board_content = #{freeBoardContent},
	 		free_board_thumbnail = #{freeBoardThumbnail}
	 	where free_board_no = #{freeBoardNo}
	 </update>
	 
	 <!-- 댓글 수정 -->
	 <update id="updateComment">
	 	update fb_comment_tbl set
	 		fb_comment_content = #{fbCommentContent}
	 	where fb_comment_no = #{fbCommentNo}
	 </update>
	 
	 <select id="selectCateNo" resultType = "freeBoardCategory">
	 	select 
	 		free_board_category_no, 
	 		free_board_subcategory_no 
	 		from 
	 			free_board_category_tbl left join free_board_sub_category_tbl using (free_board_category_no)
	 		where free_board_subcategory = #{freeBoardSubcategory}
	 </select>
	 
	 <delete id="deleteComment">
	 	delete from fb_comment_tbl where fb_comment_no = #{fbCommentNo}
	 </delete>
	 
	 <select id="selectLike" resultType = "freeBoardLike">
	 	select * from fb_like_tbl where member_no = #{memberNo} and free_board_no = #{freeBoardNo}
	 </select>
	 
	 <insert id="insertLike"> 
	 	insert into fb_like_tbl values
	 	(
	 		#{memberNo},
	 		#{freeBoardNo},
	 		#{freeBoardSubcategoryNo},
	 		#{freeBoardCategoryNo},
	 		sysdate
	 	)
	 </insert>
	 
	 <delete id="deleteLike">
	 	delete from fb_like_tbl where member_no = #{memberNo} and free_board_no = #{freeBoardNo}
	 </delete>
	 
	 <select id="countLike" resultType = "freeBoardLike">
	 	select count(*) as like_count
	 		from 
			 	(select member_no, 
			 		   free_board_no, 
			 		   fb_like_date, 
			 		   count(*) as like_count 
			 		   		from fb_like_tbl 
			 		   where free_board_no = #{freeBoardNo}
	    		group by member_no, free_board_no, fb_like_date)
	 </select>
	 
	 <select id="updateViewCount">
	 	select count(*) as view_count from free_board_view_tbl 
	 		where free_board_no = #{freeBoardNo}
	 </select>
	 
	 <select id="selectViewList" resultType= "freeBoardView">
	 	select * from free_board_view_tbl 
	 			where member_no = #{memberNo} and free_board_no = #{freeBoardNo}
	 </select>
	 
	 <insert id="insertView">
	 	insert into free_board_view_tbl values
		 	(
		 		free_board_view_seq.nextval,
		 		#{memberNo},
		 		#{freeBoardNo},
		 		#{freeBoardCategoryNo},
		 		#{freeBoardSubcategoryNo}
		 	)
	 </insert>
	 
	 <select id="countView" resultType = "freeBoardView">
	 	select count(*) as view_count 
	 			from 
			        (select free_view_no,
			               member_no
				 		   free_board_no, 
				 		   count(*) as view_count 
				 		   		from free_board_view_tbl
				 		   where free_board_no = #{freeBoardNo}
				group by free_view_no, member_no,free_board_no)
	 </select>
	 
	 <select id="selectCommentLike" resultType = "freeBoardCommentLike">
	 	select * from fbc_like_tbl where member_no = #{memberNo} and fb_comment_no = #{fbCommentNo}
	 </select>
	 
	 <insert id="insertCommentLike">
		insert into fbc_like_tbl values
		(
			#{memberNo},
			#{fbCommentNo},
			sysdate
		)	 
	 </insert>
	 
	 <delete id="deleteCommentLike">
	 	delete from fbc_like_tbl where member_no = #{memberNo} and fb_comment_no = #{fbCommentNo}
	 </delete>
	  
	 <select id="commentLike" resultType="freeBoardCommentLike">
	 	select count (*) as comment_like 
		    from (
		        select fb_comment_no from
		            fbc_like_tbl 
        where fb_comment_no = #{fbCommentNo})
	 </select>
	<!-- 
	<select id="naviBoardList" resultType = "freeBoard">
		select * from (
		    select rownum as fbnum, fb.* 
		    	from (
			      select 
			      	f.*, 
			      	m.member_nickname, 
			      	m.member_id,
			        (
			         select count(*) from 
			         	fb_like_tbl 
			         where free_board_no=f.free_board_no) as like_count
			       from 
			       	free_board_tbl f
			       left join member_tbl m on f.member_no = m.member_no
			       order by free_board_no asc
			      ) fb
			      order by fbnum desc
			    )
			  where fbnum = #{freeBoardfbNum}
	</select>
	 -->
	
	<select id="recommends" resultType="freeBoard">
		SELECT *
FROM (
    SELECT ROWNUM FB_NUM, A.*
    FROM (
        SELECT *
        FROM (
            SELECT *
            FROM (
                SELECT
                    FREE_BOARD_NO,
                    FREE_BOARD_SUBCATEGORY_NO,
                    FREE_BOARD_CATEGORY_NO,
                    FREE_BOARD_TITLE,
                    MEMBER_NO,
                    FREE_BOARD_DATE,
                    NVL(LIKE_COUNT, 0) LIKE_COUNT
                FROM FREE_BOARD_TBL
                LEFT JOIN (
                    SELECT FREE_BOARD_NO, COUNT(*) LIKE_COUNT
                    FROM FB_LIKE_TBL
                    GROUP BY FREE_BOARD_NO
                ) USING (FREE_BOARD_NO)
                WHERE FREE_BOARD_CATEGORY_NO = 2
                  AND FREE_BOARD_SUBCATEGORY_NO = 7
            )
            ORDER BY LIKE_COUNT DESC
        )
    ) A
)
WHERE FB_NUM BETWEEN 1 AND 10
	</select>
	
	
</mapper>
