<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.iei.freeboard.model.dao.FreeBoardDao">

	<select id="selectCategoryList" resultType = "freeBoardCategory">
 		SELECT 
			free_board_category_no ,FREE_BOARD_CATEGORY, free_board_subcategory_no, FREE_BOARD_SUBCATEGORY 
			FROM FREE_BOARD_SUB_CATEGORY_TBL 
		JOIN FREE_BOARD_CATEGORY_TBL USING (FREE_BOARD_CATEGORY_NO)
	</select>  
	
	<select id="searchTitle" resultType = "freeBoard">
		select * 
		from (
    		select rownum as fbnum, fb.* 
    			from (
            		select f.*, 
            		m.member_nickname, 
            		m.member_id, 
            		(select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
            from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
            where free_board_title like '%' || #{freeBoardTitle} || '%'
            <if test="order == 2">
            	order by free_board_no desc
            </if>
    		<if test="order == 1">
    			order by free_board_no asc
    		</if>
          	) fb
        )  	
        where fbnum between #{startRow} and #{endRow}
	</select>
	
	 <select id="totalSearchListCount" resultType="int">
	 	select count(*) from free_board_tbl where free_board_title like '%' || #{freeBoardTitle} || '%'
	 </select>
	 
	<select id="boardList" resultType="freeBoard">
		select * from free_board_tbl
	</select>
	
	<select id="totalBoardList" resultType = "freeBoard">
		select * from
    		(select rownum as fbnum, fb.* from
            	(select f.*, m.member_nickname, m.member_id, (select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
                from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
            <if test="order == 2">
            	order by free_board_no desc
            </if>
    		<if test="order == 1">
    			order by free_board_no asc
    		</if>
            ) fb
            <if test="selected != null">
            	where free_board_subcategory_no = #{selected}
            </if>
          	)
        where fbnum between #{startRow} and #{endRow}
	</select>
	
	<select id="totalListCount" resultType="int">
		select count(*) from free_board_tbl
	</select>
	
	<select id="totalBoardSubList" resultType = "freeBoard">
		select * from
    		(select rownum as fbnum, fb.* from
            	(select f.*, m.member_nickname, m.member_id, (select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
                from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
            ) fb
            <if test="selected != null">
            	where free_board_subcategory_no = #{selected}
            </if>
            <if test="order == 2">
            	order by free_board_no desc
            </if>
    		<if test="order == 1">
    			order by free_board_no asc
    		</if>
          	)
        where fbnum between #{startRow} and #{endRow} 
	</select>
	
	<select id="totalSubListCount" resultType = "int">
		select count(*) from free_board_tbl where free_board_subcategory_no = #{selected}
	</select>
	 
	 <select id="mainTitle" resultType="freeBoard">
	 	<![CDATA[
		    SELECT b.free_board_no,
		           b.free_board_title,
		           b.member_no,
		           m.member_nickname
		    FROM (
		        SELECT free_board_no,
		               free_board_title,
		               member_no
		        FROM free_board_tbl
		        ORDER BY free_board_no DESC
		    ) b
		    JOIN member_tbl m
		    ON b.member_no = m.member_no
		    WHERE ROWNUM <= #{limit}
		]]>
	 </select>
	 
	 <select id="isSubCategory" resultType = "freeBoardCategory">
	 	select rownum no, a.* 
    		from (select free_board_category_no, free_board_subcategory_no, free_board_subCategory 
        		from (select * from free_board_category_tbl 
            where free_board_category=#{cate}) 
        join free_board_sub_category_tbl using(free_board_category_no)) a
	 </select>
	 
	 <select id="mainCategory" resultType="freeBoard">	
	 	<![CDATA[ 
		    SELECT  b.free_board_no,
        			b.free_board_title,
        			b.member_no,
        			b.free_board_category_no,
					m.member_nickname
			FROM (
					SELECT 
							free_board_no,
		       				free_board_title,
               				free_board_category_no,
		       				member_no
					FROM free_board_tbl			
					WHERE free_board_category_no = #{freeBoardCategoryNo}
		     		ORDER BY free_board_no DESC
			) b
			JOIN member_tbl m
			ON b.member_no = m.member_no		
			WHERE rownum <= 10
		]]>		
	 </select>
	 
	 <select id="getFreeBoardNo" resultType ="int">
	 	select free_board_seq.nextval from dual
	 </select>
	 
	 <insert id="insertFreeBoard">
	 	insert into free_board_tbl values
	 		(
	 		#{freeBoardNo}, 
	 		#{freeBoardSubcategoryNo}, 
	 		#{freeBoardCategoryNo}, 
	 		#{freeBoardTitle}, 
	 		#{memberNo}, 
	 		#{freeBoardContent}, 
	 		sysdate, 
	 		#{freeBoardThumbnail}
	 		)
	 </insert>
	 <!-- 
	 <insert id="insertFreeBoardFile">
	 	insert into fb_photo_tbl values
	 		(
	 		#{freeBoardCategoryNo}, 
	 		#{freeBoardSubcategoryNo},
	 		#{freeBoardNo}, 
	 		fb_photo_seq.nextval, 
	 		#{FBPhotopath}, 
	 		#{FBPhotoname}
	 		)
	 </insert>
	  -->
	 <select id="selectOneDetail" resultType="freeBoard">
	 	select f.*, m.member_nickname, m.member_id, (select count(*) from fb_like_tbl where free_board_no=f.free_board_no) as like_count
                from free_board_tbl f
            left join member_tbl m on (f.member_no = m.member_no)
        	 where free_board_no = #{freeBoardNo}
	 </select>
	 <select id="selectOneComment" resultType = "freeBoardComment">
	 	select * 
		    from (
		        select * 
		            from (
		                select * 
			                from (
			                    select 
			                        a.free_board_no,
			                        b.fb_comment_no,
			                        b.fb_comment_content,
			                        a.free_board_date,
			                        b.fb_comment_date,
			                        b.member_no,
			                        count(fb_comment_no) as comment_count
			                    from free_board_tbl a 
			                    left join fb_comment_tbl b 
			                        on (a.free_board_no = b.free_board_no)
			                    group by 
			                        a.free_board_no, 
			                        b.fb_comment_no, 
			                        b.fb_comment_content,
			                        a.free_board_date, 
			                        b.fb_comment_date, 
			                        b.member_no
		                	) 
		                left join (
		                    select 
		                        member_no,
		                        member_nickname,
		                        member_id 
		                    from member_tbl
		                ) using (member_no)
		            )
		        left join (
		            select 
		                fb_comment_no,
		                count(*) as cnt 
		            from fb_comment_tbl 
		            group by fb_comment_no
		        ) using (fb_comment_no)
		    )
		where free_board_no = #{freeBoardNo}
		order by 1 desc
	 </select>
		
	<insert id="insertComment">
		insert into fb_comment_tbl values 
			(
			fb_comment_seq.nextval,
			#{freeBoardNo},
			#{freeBoardSubcategoryNo},
			#{freeBoardCategoryNo},
			#{memberNo},
			#{fbCommentContent},
			sysdate,
			'F',
			null
			)
	</insert> 
	 
	 <select id="selectOneBoard" resultType = "freeBoard">
	 	select * from free_board_tbl where free_board_no = #{freeBoardNo}
	 </select>
	 <select id="selectCate" resultType="freeBoard">
	 SELECT FREE_BOARD_SUBCATEGORY_NO,FREE_BOARD_CATEGORY_NO FROM FREE_BOARD_TBL WHERE FREE_BOARD_NO=#{freeBoardNo}
	 </select>
	 
	 <insert id="insertClaim">
	 INSERT INTO FB_CLAIM_TBL VALUES(#{freeBoardNo},#{memberNo},#{freeBoardSubcategoryNo},#{freeBoardCategoryNo},SYSDATE,#{fbClaimReason})
	 </insert>
	 
	 <insert id="insertCommentClaim">
	 INSERT INTO FBC_CLAIM_TBL VALUES(#{memberNo},#{fbCommentNo},#{fbcClaimReason},SYSDATE)
	 </insert>
	 
	 <delete id="deleteFreeBoard">
	 	delete from free_board_tbl where free_board_no = #{freeBoardNo}
	 </delete>
	 
	 <select id="selectCategory" resultType = "freeBoardCategory">
	 	select free_board_subcategory, 
	        free_board_category 
	            from free_board_sub_category_tbl 
	        left join free_board_category_tbl using (free_board_category_no)
	    where free_board_subcategory_no = #{freeBoardSubcategoryNo} and free_board_category_no = #{freeBoardCategoryNo}
	 </select>
	 
	 <update id="modifyFreeBoard">
	 	update free_board_tbl set 
	 		free_board_subcategory_no = #{freeBoardSubcategoryNo},
	 		free_board_category_no = #{freeBoardCategoryNo},
	 		free_board_title = #{freeBoardTitle},
	 		free_board_content = #{freeBoardContent},
	 		free_board_thumbnail = #{freeBoardThumbnail}
	 	where free_board_no = #{freeBoardNo}
	 </update>
	 
	 <!-- 댓글 수정 -->
	 <update id="updateComment">
	 	update fb_comment_tbl set
	 		fb_comment_content = #{fbCommentContent}
	 	where fb_comment_no = #{fbCommentNo}
	 </update>
	 
	 <select id="selectCateNo" resultType = "freeBoardCategory">
	 	select 
	 		free_board_category_no, 
	 		free_board_subcategory_no 
	 		from 
	 			free_board_category_tbl left join free_board_sub_category_tbl using (free_board_category_no)
	 		where free_board_subcategory = #{freeBoardSubcategory}
	 </select>
	 
	 <delete id="deleteComment">
	 	delete from fb_comment_tbl where fb_comment_no = #{fbCommentNo}
	 </delete>
	 
</mapper>
